<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>看谁能坚持一分钟</title>
	<style>
		html,body{
			height: 100%;
			margin: 0;
			padding: 0;
		}
		#bg-canvas{
			margin:auto; position: absolute; z-index:-10;width: 100vw;top:0px;left:0px;
			/*height:1030px;*/
			height:108%;
		}
		#icon_1{position: absolute;top: 1px;left: 1%;z-index: 997}
        #icon_2{position: absolute;bottom: -8%;left: 1%; z-index: 996}
		#wrap{width: 1280px;height: 720px;position: absolute;z-index: 888;background: url(image/selectGlassess.png) no-repeat;cursor: auto;top: 0px;left: 15%;}
        #textWen{font-size: 30px;color: #FFF;text-align: center; padding-top: 270px;}
		#btn{width: 187px;height: 80px;background: url(image/confirm3.png);border: none;margin-top: 80px;margin-left: 40%;}
	</style>
	<script src="js/jquery.min.js"></script>
	<script src="js/create.js"></script>
	<script src="js/common.js"></script>
	<script src="js/stbg.js"></script>
	<script src="js/phaser.min.js"></script>
</head>
<body>
	<div id="container">
	</div>
	<div id="wrap">
        <p id="textWen">请观察星星的运动方式,找出运动不同的星星,迅速点击屏幕,找对有惊喜！</p>
        <button id="btn"></button>
</div>
	<div id="icon_1"><img src="image/help2.png"></div>
    <div id="icon_2"> <a href="idolater.html"><img src="image/reset1.png"></a></div>
	   <canvas id="bg-canvas" width="1024" height="720" ></canvas>
	<script>
	// 背景控件
	$(document).ready(function(){
        canvasBgone();
		function canvasBgone(){
                            var config = {
                            barWidth: 5,
                            deltaTime: 400,
                            showTimes: 8
                        }
                        console.log(1);
                        if(window.stbg) stbg.removeSelf();
                        window.stbg = new STBG(config);
                }
						$("#wrap").hide();
							$("#icon_1").click(function(){
							$("#wrap").show();
							$("#container").hide();
						});
						$("#btn").click(function(){
							$("#wrap").hide();
							$("#container").show();
             });
	})
	// 雪花变量组
	var max = 0;
	var front_emitter;
	var mid_emitter;
	var back_emitter;
	var update_interval = 4 * 60;
	var i = 0;

			// var timer;
			// var total = 0;

	document.body.style.margin = "0px";
	onload=function(){
		/////////////////////////////SET///////////////////////////////////////////
		var loading;
		var progressText;
		////////////////////////////BOOTSTATE//////////////////////////////////////
		var bootState = function(game){
			this.preload=function(){
				game.load.image('loading','./assets/preloader.gif');
			};
			this.create=function(){
				// game.stage.backgroundColor = '#2384e7';
				game.state.start('loader');
			};
		}
		////////////////////////////LOADERSTATE////////////////////////////////////
		var loaderState=function(game){
			this.init=function(){
				loading=game.add.image(game.world.centerX,game.world.centerY,'loading');
				loading.anchor={x:0.5,y:0.5};
				progressText=game.add.text(game.world.centerX,game.world.centerY+30,'0%',{fill:'#fff',fontSize:'16px'});
				progressText.anchor={x:0.5,y:0.5};
				//自动检测游戏窗口变化
				this.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
                this.scale.pageAlignHorizontally = true;
                this.scale.pageAlignVertically = true;
			};
			this.preload=function(){
				game.load.audio('gameMusic', 'assets/gameMusic.mp3'); //游戏背景音乐
				// game.load.image('background','assets/background.png');
				game.load.image('around_h','assets/around_h.png');
				game.load.image('around_v','assets/around_v.png');
				game.load.spritesheet('enemy','assets/baddie.png',32,32);
				game.load.spritesheet('player','assets/dude.png',32,48);
				game.load.image('logo','assets/logo.png');
				game.load.image('button','assets/restart.png');

				game.load.spritesheet('snowflakes', 'assets/snowflakes.png', 17, 17);
                game.load.spritesheet('snowflakes_large', 'assets/snowflakes_large.png', 64, 64);
				game.load.onFileComplete.add(function(progress){
					progressText.text=progress+'%';
				});
			}
			this.create=function(){
				// 雪花背景
                snowBg();
				game.music = this.add.audio('gameMusic', 1, true);
				game.music.play('',0,1,true);
				loading.kill();
				progressText.destroy();
				var text = game.add.text(0,game.world.height/15,'据说世界上只有5%的小朋友能够坚持五分钟！',{fill:'#fff',fontSize:'48px'});
				text.setShadow(3, 3, 'rgba(0,0,0,0.8)', 2);
				text.x=(game.world.width-text.width)/2;
				text.alpha=1;
                //黑色横幅 
				var bar = game.add.graphics();
					bar.beginFill(0x000000, 0.5);
					bar.drawRect(0, 25, 1280, 100);
				//  文字内容
                var styleText = { font: "bold 32px Arial", fill: "#fff", boundsAlignH: "center", boundsAlignV: "middle" };
				var textClick = game.add.text(game.world.centerX/1.4,180,'点击Phaser英雄开始训练',styleText);
				textClick.alpha=1;
                // logo按钮
				game.add.tween(text).from( { alpha: 0 }, 4000, Phaser.Easing.Bounce.Out, true);
			    var sprite = game.add.sprite(game.world.centerX, game.world.centerY, 'logo');
			    sprite.anchor.set(0.5);
			    game.add.tween(sprite).from( { y: -200 }, 2000, Phaser.Easing.Bounce.Out, true);
			    sprite.inputEnabled = true;
			    sprite.events.onInputDown.add(function(){
			    	game.state.start('main');
			    }, this);
			}
		}
		//////////////////////////MAINSTATE////////////////////////////////
		var mainState=function(game){

			var score = 1;
			var timeStr;
			var timeStrs;
			var enemy=[];
			var enemys;
			var enemy;
			var player;
			var around;
			var cursors;
			var playerV = 150;
			this.create=function(){
				snowBg();
				game.physics.startSystem(Phaser.ARCADE);
				// game.add.image(0,0,'background');
				// game.add.image(0.0,'baddie');
				enemys=game.add.group();
			   
				enemys.enableBody=true;

				enemy = game.add.sprite(0,0,'baddie');
				// game.physics.arcade.enable(enemy);
				// enemys.create(75,35,'enemy');
				enemy.animations.add('baddie',[0,1,2,3],4,true);
				// enemy.animations.play('enemy');
				enemy.animations.play('baddie',8,true); 
				// game.add.tween(enemy).to({ x:260 ,y:200},5000,null,true,0,Number.MAX_VALUE,true);
				enemys.create(32,32,'enemy');

				around=game.add.group();
				around.enableBody=true;
				around.create(0,0,'around_h');
				around.create(game.world.width-30,0,'around_h');
				around.create(0,0,'around_v');
				around.create(0,game.world.height-30,'around_v');
				
				player=game.add.sprite(0,0,'player');
				game.physics.arcade.enable(player);
				player.x=(game.world.width-player.width)/2;
				// player.y=(game.world.height-player.height)/2;
			    player.y=655;
				player.scale.setTo(0.7);
				player.inputEnabled=true;
				player.input.enableDrag(false);
			    
				loopMove(enemys.getChildAt(0),3,3);	
				timeStr = game.add.text(0,game.world.height/9,"当前时间:"+score);
				timeStrs = game.add.text(-200,game.world.height/9,score);

				// timeStr = game.add.text(0,game.world.height/9);
			
		     	// timer = game.time.create(false);
				// timer.loop(1000,uploadCounter,this);
				// timer.start();

                game.time.events.add(Phaser.Timer.SECOND * 10,twoEnemys,this);
				game.time.events.add(Phaser.Timer.SECOND * 20,threeEnemys,this);
				game.time.events.add(Phaser.Timer.SECOND * 30,fourEnemys,this);
				game.time.events.add(Phaser.Timer.SECOND * 40,fiveEnemys,this);
				game.time.events.add(Phaser.Timer.SECOND * 50,sixEnemys,this);
                player.animations.add('left',[0,1,2,3],10,true);
				//添加动画，左执行1-4帧，10帧每秒速度播放，循环播放
				player.animations.add('right',[5,6,7,8],10,true);
				//添加动画，右执行1-4帧，10帧每秒速度播放，循环播放
			}
			// function uploadCounter() {
            //    total++;
            //  }
	//---------- 第四个敌人
	function twoEnemys(){
				enemys.create(32,32,'enemy');
				loopMove(enemys.getChildAt(1),3,3);
					console.log("第二个敌人");	
		     	}
	function threeEnemys(){
               enemys.create(32,32,'enemy');
				   loopMove(enemys.getChildAt(2),3,3);	
					console.log("第三个敌人");
		     	}
	function fourEnemys(){
				enemys.create(32,32,'enemy');
				loopMove(enemys.getChildAt(3),3,3);	
				console.log("第四个敌人");
		     	}
	function fiveEnemys(){
				enemys.create(32,32,'enemy');
				loopMove(enemys.getChildAt(4),3,3);	
				console.log("第五个敌人");
		     	}
	function sixEnemys(){
				enemys.create(32,32,'enemy');
				loopMove(enemys.getChildAt(5),3,3);	
				console.log("第六个敌人");
		     	}
			this.update=function(){		
                cursors = game.input.keyboard.createCursorKeys();//键盘事件
				if(player.alive){
					 player.body.velocity.x = 0;//加速度默认值0
					 player.body.velocity.y = 0;
				if (cursors.left.isDown) {
					player.body.velocity.x = -playerV;
					player.animations.play('left');
				}else if (cursors.right.isDown) {
					player.body.velocity.x = +playerV;
				player.animations.play('right');
				}
				// }else if (cursors.up.isDown) {
				// 	player.body.velocity.y = -playerV;
				// 	// player.animations.play('right');
				// }else if (cursors.down.isDown) {
				// 	player.body.velocity.y = +playerV;
				// 	// player.animations.play('right');
				// }
				else {
					player.animations.stop();
				    player.frame = 4;//第四帧
				}
				game.physics.arcade.overlap(player,around,function(){
					game.state.start('theEnd');
				});		
				game.physics.arcade.overlap(player,enemys,function(){
					game.state.start('theEnd');
				});
			}
			}
			this.render=function(){
				// game.debug.text('Time until event: ' + timer.duration.toFixed(1), 350, 128,{fill:'#fff',fontSize:'48px'});
                // game.debug.text('当前时间: ' + total    + "s", 350, 128,{fill:'#fff',fontSize:'48px'});
				if(score > 0){
                  score+= 0.01;
				   timeStr.text ='当前时间:' + score.toFixed(1)+ "s";
				   timeStrs.text = score.toFixed(1)+ "s";
				}
				ts = timeStrs.text;

				// timeStr.text = game.time.totalElapsedSeconds().toFixed(3)+"s";
				// timeStr.text = game.add.text(60, 60,'得分： '+ score,{fill:'#fff',fontSize:'20px'});

				timeStr.x=(game.world.width-timeStr.width)/2;
			}
			  i++;
    if (i === update_interval)
    {
        changeWindDirection();
        update_interval = Math.floor(Math.random() * 20) * 60; // 0 - 20sec @ 60fps
        i = 0;
    }
}
	function changeWindDirection() {
			var multi = Math.floor((max + 200) / 4),
				frag = (Math.floor(Math.random() * 100) - multi);
			max = max + frag;

			if (max > 200) max = 150;
			if (max < -200) max = -150;

			setXSpeed(back_emitter, max);
			setXSpeed(mid_emitter, max);
			setXSpeed(front_emitter, max);
         }
function snowBg(){
			back_emitter = game.add.emitter(game.world.centerX, -32, 600);
			back_emitter.makeParticles('snowflakes', [0, 1, 2, 3, 4, 5]);
			back_emitter.maxParticleScale = 0.6;
			back_emitter.minParticleScale = 0.2;
			back_emitter.setYSpeed(20, 100);
			back_emitter.gravity = 0;
			back_emitter.width = game.world.width * 1.5;
			back_emitter.minRotation = 0;
			back_emitter.maxRotation = 40;

			mid_emitter = game.add.emitter(game.world.centerX, -32, 250);
			mid_emitter.makeParticles('snowflakes', [0, 1, 2, 3, 4, 5]);
			mid_emitter.maxParticleScale = 1.2;
			mid_emitter.minParticleScale = 0.8;
			mid_emitter.setYSpeed(50, 150);
			mid_emitter.gravity = 0;
			mid_emitter.width = game.world.width * 1.5;
			mid_emitter.minRotation = 0;
			mid_emitter.maxRotation = 40;

			front_emitter = game.add.emitter(game.world.centerX, -32, 50);
			front_emitter.makeParticles('snowflakes_large', [0, 1, 2, 3, 4, 5]);
			front_emitter.maxParticleScale = 1;
			front_emitter.minParticleScale = 0.5;
			front_emitter.setYSpeed(100, 200);
			front_emitter.gravity = 0;
			front_emitter.width = game.world.width * 1.5;
			front_emitter.minRotation = 0;
			front_emitter.maxRotation = 40;

			changeWindDirection();

			back_emitter.start(false, 14000, 20);
			mid_emitter.start(false, 12000, 40);
			front_emitter.start(false, 6000, 1000);

}
function setXSpeed(emitter, max) {
			emitter.setXSpeed(max - 20, max);
			emitter.forEachAlive(setParticleXSpeed, this, max);
}

function setParticleXSpeed(particle, max) {
    particle.body.velocity.x = max - Math.floor(Math.random() * 30);
}
		//////////////////////////THEENDSTATE///////////////////////////////////////
		var theEndState = function(game){
			this.create=function(){
				var text = game.add.text(0,game.world.height/4);
				// ts.text = score;
				text.text='你坚持了'+ts;
				text.x=(game.world.width-text.width)/2;
				var button=game.add.button(0,-200,'button',function(){
					location.reload();
				});
				button.x=(game.world.width-button.width)/2;
				game.add.tween(button).to( { y: game.world.centerY }, 2000, Phaser.Easing.Bounce.Out, true);
			};
		}
		///////////////////////////PUBLIC/////////////////////////////////////////////////
		var game=new Phaser.Game(1280,720,Phaser.AUTO,'container','',true);
		game.state.add('boot',bootState);
		game.state.add('loader',loaderState);
		game.state.add('main',mainState);
		game.state.add('theEnd',theEndState);
		game.state.start('boot');		
		///////////////////////////FUNCTION////////////////////////////////////////////////
		function loopMove(obj,x,y){	
			game.time.events.loop(Phaser.Timer.SECOND/70, function(){
				if (obj.x <= 30  ) {x = -x}
				if (obj.y <= 30  ) {y = -y}
				//有效活动范围
				if (obj.x > game.world.width -30-obj.width) {x = -x}
				if (obj.y > game.world.height - 30-obj.height) {y = -y}
				// obj.x = obj.x + x;
				obj.x = obj.x + x;
				obj.y = obj.y + y;
			}, this);
		}
	}
	</script>
	


</body>
</html>