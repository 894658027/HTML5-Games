<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>看谁能坚持一分钟</title>
	<style>
	*{margin: 0px;padding: 0px;}
		html,body{
			height: 100%;
			margin: 0;
			padding: 0;
			background-color: black;
		}
		#container{
			overflow: hidden;
		}
		#container canvas{
			margin: 4% auto;
		}
		/*canvas {margin: 0px;}*/
	</style>
	<script src="js/phaser.min.js"></script>
</head>
<body>
	<div id="container"></div>
	<script>
	document.body.style.margin = "0px"
	onload=function(){
		/////////////////////////////SET///////////////////////////////////////////
		var loading;
		var progressText;
		var timeStr;
		////////////////////////////BOOTSTATE//////////////////////////////////////
		var bootState = function(game){
			this.preload=function(){
				game.load.image('loading','./assets/preloader.gif');
			};
			this.create=function(){
				game.stage.backgroundColor = '#2384e7';
				game.state.start('loader');
			};
		}
		////////////////////////////LOADERSTATE////////////////////////////////////
		var loaderState=function(game){
			this.init=function(){
				loading=game.add.image(game.world.centerX,game.world.centerY,'loading');
				loading.anchor={x:0.5,y:0.5};
				progressText=game.add.text(game.world.centerX,game.world.centerY+30,'0%',{fill:'#fff',fontSize:'16px'});
				progressText.anchor={x:0.5,y:0.5};
				this.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
			    // this.scale.scaleMode = Phaser.ScaleManager.RESIZE;
                this.scale.pageAlignHorizontally = true;
                this.scale.pageAlignVertically = true;
			};
			this.preload=function(){
				game.load.audio('gameMusic', 'assets/gameMusic.mp3?332'); //游戏背景音乐
				game.load.image('background','assets/background.png');
				game.load.image('around_h','assets/around_h.png');
				game.load.image('around_v','assets/around_v.png');
				// game.load.image('enemy','assets/enemy.png');
				game.load.spritesheet('enemy','assets/baddie.png',32,32);
				// game.load.image('player','assets/player.png');
				game.load.spritesheet('player','assets/dude.png',32,48);
				game.load.image('logo','assets/logo.png');
				game.load.image('button','assets/restart.png');
				
				game.load.onFileComplete.add(function(progress){
					progressText.text=progress+'%';
				});
			}
			this.create=function(){
//自动检测游戏窗口变化
				game.music = this.add.audio('gameMusic', 1, true);
				game.music.play('',0,1,true);
				loading.kill();
				progressText.destroy();
				var text = game.add.text(0,game.world.height/4,'据说世界上只有5%的小朋友能够坚持五分钟！',{fill:'#fff',fontSize:'48px'});
				text.setShadow(3, 3, 'rgba(0,0,0,0.5)', 2);
				text.x=(game.world.width-text.width)/2;
				text.alpha=1;

				var bar = game.add.graphics();
					bar.beginFill(0x000000, 0.2);
					bar.drawRect(0, 150, 1280, 100);

                var styleText = { font: "bold 32px Arial", fill: "#fff", boundsAlignH: "center", boundsAlignV: "middle" };
				// var textClick = game.add.text(0,game.world.height/6,'点击Phaser英雄开始训练',style);
				var textClick = game.add.text(game.world.centerX/1.4,0,'点击Phaser英雄开始训练',styleText);
				// textClick.x=(game.world.width-text.width)/3;
				textClick.alpha=1;

				game.add.tween(text).from( { alpha: 0 }, 4000, Phaser.Easing.Bounce.Out, true);
			    var sprite = game.add.sprite(game.world.centerX, game.world.centerY, 'logo');
			    sprite.anchor.set(0.5);
			    game.add.tween(sprite).from( { y: -200 }, 2000, Phaser.Easing.Bounce.Out, true);
			    sprite.inputEnabled = true;
			    sprite.events.onInputDown.add(function(){
			    	game.state.start('main');
			    }, this);
			}
		}
		//////////////////////////MAINSTATE////////////////////////////////
		var mainState=function(game){
			var enemy=[];
			var enemys;
			// var enemya;
			var player;
			var around;
			var cursors;
			var playerV = 150;
			this.create=function(){
				game.physics.startSystem(Phaser.ARCADE);
				game.add.image(0,0,'background');
				// game.add.image(0.0,'baddie');
				enemys=game.add.group();
			   
				enemys.enableBody=true;

				enemy = game.add.sprite(0,0,'baddie');
				// game.physics.arcade.enable(enemy);
				// enemys.create(75,35,'enemy');
				enemy.animations.add('baddie',[0,1,2,3],4,true);
				// enemy.animations.play('enemy');
				enemy.animations.play('baddie',8,true); 
				// game.add.tween(enemy).to({ x:260 ,y:200},5000,null,true,0,Number.MAX_VALUE,true);
				enemys.create(32,32,'enemy');

				around=game.add.group();
				around.enableBody=true;
				around.create(0,0,'around_h');
				around.create(game.world.width-30,0,'around_h');
				around.create(0,0,'around_v');
				around.create(0,game.world.height-30,'around_v');
				
				player=game.add.sprite(0,0,'player');
				game.physics.arcade.enable(player);
				player.x=(game.world.width-player.width)/2;
				player.y=(game.world.height-player.height)/2;
				player.scale.setTo(0.7);
				player.inputEnabled=true;
				player.input.enableDrag(false);
			    
                // player.animations.add('walk', [0, 1, 2, 3, 4, 5, 6, 7, 8]);
                // player.animations.play('walk', 20, true);

				loopMove(enemys.getChildAt(0),3,3);	
				timeStr = game.add.text(0,game.world.height/9);
			
                game.time.events.add(Phaser.Timer.SECOND * 10,twoEnemys,this);
				game.time.events.add(Phaser.Timer.SECOND * 20,threeEnemys,this);
				game.time.events.add(Phaser.Timer.SECOND * 30,fourEnemys,this);
				game.time.events.add(Phaser.Timer.SECOND * 40,fiveEnemys,this);
				game.time.events.add(Phaser.Timer.SECOND * 50,sixEnemys,this);

                player.animations.add('left',[0,1,2,3],10,true);
				//添加动画，左执行1-4帧，10帧每秒速度播放，循环播放
				player.animations.add('right',[5,6,7,8],10,true);
				//添加动画，右执行1-4帧，10帧每秒速度播放，循环播放
				bg = game.add.tileSprite(0, 0, 800, 600, 'space');
			}
			 
	//---------- 第四个敌人
	function twoEnemys(){
				enemys.create(32,32,'enemy');
				//enemys.getChildAt(1).scale.setTo(2,1);
				//enemys.getChildAt(1).x=game.world.width-enemys.getChildAt(1).width-50;
				loopMove(enemys.getChildAt(1),3,3);
					console.log("第二个敌人");	
		     	}
	function threeEnemys(){
               enemys.create(32,32,'enemy');
				   loopMove(enemys.getChildAt(2),3,3);	
					console.log("第三个敌人");
		     	}
	function fourEnemys(){
				enemys.create(32,32,'enemy');
				loopMove(enemys.getChildAt(3),3,3);	
				console.log("第四个敌人");
		     	}
	function fiveEnemys(){
				enemys.create(32,32,'enemy');
				loopMove(enemys.getChildAt(4),3,3);	
				console.log("第五个敌人");
		     	}
	function sixEnemys(){
				enemys.create(32,32,'enemy');
				loopMove(enemys.getChildAt(5),3,3);	
				console.log("第六个敌人");
		     	}
			this.update=function(){		
			 
				bg.tilePosition.y += 0.7;
cursors = game.input.keyboard.createCursorKeys();//键盘事件
				if(player.alive){
					 player.body.velocity.x = 0;//加速度默认值0
					 player.body.velocity.y = 0;
				if (cursors.left.isDown) {
					player.body.velocity.x = -playerV;
					player.animations.play('left');
				}else if (cursors.right.isDown) {
					player.body.velocity.x = +playerV;
					player.animations.play('right');
				}else if (cursors.up.isDown) {
					player.body.velocity.y = -playerV;
					// player.animations.play('right');
				}else if (cursors.down.isDown) {
					player.body.velocity.y = +playerV;
					// player.animations.play('right');
				}else {
					player.animations.stop();
				    player.frame = 4;//第四帧
				}
				game.physics.arcade.overlap(player,around,function(){
					game.state.start('theEnd');
				});		
				game.physics.arcade.overlap(player,enemys,function(){
					game.state.start('theEnd');
				});
			}
			}
			this.render=function(){
				timeStr.text = game.time.totalElapsedSeconds().toFixed(3)+"s";
				timeStr.x=(game.world.width-timeStr.width)/2;
			}
		}
		//////////////////////////THEENDSTATE///////////////////////////////////////
		var theEndState = function(game){
			this.create=function(){
				var text = game.add.text(0,game.world.height/4);
				text.text='你坚持了'+timeStr.text;
				text.x=(game.world.width-text.width)/2;
				var button=game.add.button(0,-200,'button',function(){
					location.reload();
				});
				button.x=(game.world.width-button.width)/2;
				game.add.tween(button).to( { y: game.world.centerY }, 2000, Phaser.Easing.Bounce.Out, true);
			};
		}
		///////////////////////////PUBLIC/////////////////////////////////////////////////
		var game=new Phaser.Game(1280,720,Phaser.AUTO,'container');
		game.state.add('boot',bootState);
		game.state.add('loader',loaderState);
		game.state.add('main',mainState);
		game.state.add('theEnd',theEndState);
		game.state.start('boot');		
		///////////////////////////FUNCTION////////////////////////////////////////////////
		function loopMove(obj,x,y){	
			game.time.events.loop(Phaser.Timer.SECOND/70, function(){
				if (obj.x <= 30  ) {x = -x}
				if (obj.y <= 30  ) {y = -y}
				//有效活动范围
				if (obj.x > game.world.width -30-obj.width) {x = -x}
				if (obj.y > game.world.height - 30-obj.height) {y = -y}
				// obj.x = obj.x + x;
				obj.x = obj.x + x;
				obj.y = obj.y + y;
			}, this);
		}
	}
	</script>
</body>
</html>