var tiled;!function(t){var i=function(){function i(i,e,s,r,n){if(this.tileX=s,this.tileY=r,this._currentFrame=0,n){this._tilemap=i,this._tileset=e,this._data=n,this._animations=[],this._currentFrame=0;var h=n.children;if(h)for(var a=0;a<h.length;a++){var o=h[a],l=new t.TMXAnimationFrame(i,e,s,r,o);this._animations[a]=l}}}var e=__define,s=i,r=s.prototype;return r.render=function(){this._currentFrame++,this._currentFrame=this._currentFrame%this._animations.length},e(r,"currentAnimationFrame",function(){return this._animations[this._currentFrame]}),e(r,"animations",function(){return this._animations}),i}();t.TMXAnimation=i,egret.registerClass(i,"tiled.TMXAnimation")}(tiled||(tiled={}));var tiled;!function(t){var i=function(){function i(i,e,s,r,n){this._tiledid=+n.attributes.tileid,this._duration=+n.attributes.duration,this._tile=new t.TMXTile(s,r,this._tiledid+e.firstgid,i,e)}var e=__define,s=i,r=s.prototype;return e(r,"tile",function(){return this._tile}),e(r,"tiledId",function(){return this._tiledid}),e(r,"duration",function(){return this._duration}),i}();t.TMXAnimationFrame=i,egret.registerClass(i,"tiled.TMXAnimationFrame")}(tiled||(tiled={}));var tiled;!function(t){var i=function(){function t(){}var i=(__define,t);i.prototype;return t.TMX_FLIP_H=2147483648,t.TMX_FLIP_V=1073741824,t.TMX_FLIP_AD=536870912,t.TMX_CLEAR_BIT_MASK=536870911,t.LAYER="layer",t.OBJECT_GROUP="objectgroup",t.PROPERTIES="properties",t.DATA="data",t.OBJECT="object",t.IMAGE="image",t.IMAGE_LAYER="imagelayer",t.TILE_SET="tileset",t.TILE="tile",t.TILE_OFFSET="tileoffset",t.ANIMATION="animation",t.DEFAULT_COLOR=10526884,t.DRAWORDER_INDEX="index",t.POLYGON="polygon",t.POLYLINE="polyline",t.ELLIPSE="ellipse",t.TILE_OBJECT_GROUP="tileobjectgroup",t.ORIENTATION_ORTHOGONAL="orthogonal",t.ORIENTATION_ISOMETRIC="isometric",t.ORIENTATION_STAGGERED="staggered",t.ORIENTATION_HEXAGONAL="hexagonal",t}();t.TMXConstants=i,egret.registerClass(i,"tiled.TMXConstants")}(tiled||(tiled={}));var tiled;!function(t){var i=function(t){function i(i,e,s,r){void 0===e&&(e=null),void 0===s&&(s=!0),void 0===r&&(r=!1),t.call(this,i,s,r),this.texture=e}__extends(i,t);var e=(__define,i);e.prototype;return i.IMAGE_COMPLETE="complete",i.ALL_IMAGE_COMPLETE="allComplete",i}(egret.Event);t.TMXImageLoadEvent=i,egret.registerClass(i,"tiled.TMXImageLoadEvent")}(tiled||(tiled={}));var tiled;!function(t){var i=function(i){function e(e,s,r){i.call(this),this._tilemap=e,this._color=s,this._z=r,this.graphics.beginFill(t.TMXUtils.color16ToUnit(this._color),1),this.graphics.drawRect(0,0,e.renderwidth,e.renderheight),this.graphics.endFill()}__extends(e,i);var s=(__define,e);s.prototype;return e}(egret.Sprite);t.TMXColorLayer=i,egret.registerClass(i,"tiled.TMXColorLayer")}(tiled||(tiled={}));var tiled;!function(t){var i=function(t){function i(i,e,s){t.call(this),this._tilemap=i,this._data=e,this._z=s}__extends(i,t);var e=__define,s=i,r=s.prototype;return e(r,"tilemap",function(){return this._tilemap}),e(r,"z",function(){return this._z}),r.draw=function(t){},i}(egret.Sprite);t.TMXLayerBase=i,egret.registerClass(i,"tiled.TMXLayerBase",["tiled.ILayer"])}(tiled||(tiled={}));var tiled;!function(t){var i=function(i){function e(e,s,r){i.call(this,e,s,r),this._name=s.attributes.name,this.x=+s.attributes.x,this.y=+s.attributes.y,this._z=r,this._opacity="undefined"!=typeof+s.attributes.opacity?+s.attributes.opacity:1,this.visible="undefined"!=typeof+s.attributes.visible?Boolean(+s.attributes.visible):!0;var n=s.children;if(n)for(var h=0;h<n.length;h++){var a=s.children[h];switch(a.localName){case t.TMXConstants.IMAGE:this._source=a.attributes.source,this._transColor=a.attributes.trans,this.loadImage(this.tilemap.baseURL+this._source);break;case t.TMXConstants.PROPERTIES:this._properties=this._tilemap.parseProperties(a);break;default:throw new Error("TMXTileMap decode ImageLayer is Error："+a.localName)}}}__extends(e,i);var s=__define,r=e,n=r.prototype;return s(n,"bitmap",function(){return this._bitmap}),s(n,"texture",function(){return this._texture}),s(n,"alpha",function(){return this._opacity}),n.loadImage=function(i){null!=i&&""!=i&&RES.getResByUrl(i,function(i){i&&(this._sourcebitmap.texture=i,this._texture=i,this.dispatchEvent(new t.TMXImageLoadEvent(t.TMXImageLoadEvent.IMAGE_COMPLETE,i)))},this,RES.ResourceItem.TYPE_IMAGE)},n.draw=function(t){var i=new egret.RenderTexture,e=new egret.Rectangle(this.x,this.y,this._sourcebitmap.width,this._sourcebitmap.height);t=e.intersection(t),t.right=Math.ceil(this.tilemap.width/this.tilemap.tilewidth)*this.tilemap.tilewidth,t.bottom=Math.ceil(this.tilemap.height/this.tilemap.tileheight)*this.tilemap.tileheight,i.drawToTexture(this._sourcebitmap,t),this._bitmap=new egret.Bitmap,this._bitmap.texture=i,this._bitmap.alpha=this._opacity,this._bitmap.visible=this.visible,this.addChild(this._bitmap)},e}(t.TMXLayerBase);t.TMXImageLayer=i,egret.registerClass(i,"tiled.TMXImageLayer")}(tiled||(tiled={}));var tiled;!function(t){var i=function(i){function e(e,s,r,n,h,a,o){i.call(this,e,o,a),this._staticContainer=new egret.Sprite,this.addChild(this._staticContainer),setTimeout(function(t){t._staticContainer.cacheAsBitmap=!0},2e3,this),this._animationContainer=new egret.Sprite,this.addChild(this._animationContainer),this._tilemap=e,this._tilewidth=s,this._tileheight=r,this._orientation=n,this._tilesets=h,this.tileset=this._tilesets?this._tilesets.getTilesetByIndex(0):null,this.maxTileSize={width:0,height:0};for(var l=0;l<this._tilesets.length;l++){var d=this._tilesets.getTilesetByIndex(l);this.maxTileSize.width=Math.max(this.maxTileSize.width,d.tilewidth),this.maxTileSize.height=Math.max(this.maxTileSize.height,d.tileheight)}this._name=o.attributes.name,this._cols=+o.attributes.width,this._rows=+o.attributes.height,this._opacity="undefined"!=typeof o.attributes.opacity?parseFloat(o.attributes.opacity):1,this.visible="undefined"!=typeof o.attributes.visible?Boolean(+o.attributes.visible):!0,this._hexsidelength=+o.attributes.hexsidelength,this._staggeraxis=o.attributes.staggeraxis,this._staggerindex=+o.attributes.staggerindex,"isometric"===this._orientation?(this.width=(this._cols+this._rows)*(this._tilewidth/2),this.height=(this._cols+this._rows)*(this._tileheight/2)):(this.width=this._cols*this._tilewidth,this.height=this._rows*this._tileheight),this.initArray(this._cols,this._rows);var _=o.children;if(_)for(var l=0;l<_.length;l++){var u=_[l];switch(u.localName){case t.TMXConstants.DATA:this.parseLayerData(t.TMXUtils.decode(u,u.attributes.encoding,u.attributes.compression));break;case t.TMXConstants.PROPERTIES:this._properties=this.tilemap.parseProperties(u);break;default:throw new Error("TMXTileMap decode Layer is Error："+u.localName)}}this.alpha=this._opacity,this.visible=this.visible}__extends(e,i);var s=__define,r=e,n=r.prototype;return s(n,"name",function(){return this._name}),s(n,"staticContainer",function(){return this._staticContainer}),s(n,"animationContainer",function(){return this._animationContainer}),s(n,"tilewidth",function(){return this._tilewidth}),s(n,"tileheight",function(){return this._tileheight}),s(n,"orientation",function(){return this._orientation}),s(n,"rows",function(){return this._rows}),s(n,"cols",function(){return this._cols}),s(n,"hexsidelength",function(){return this._hexsidelength}),s(n,"staggeraxis",function(){return this._staggeraxis}),s(n,"staggerindex",function(){return this.staggerindex}),s(n,"opacity",function(){return this._opacity}),s(n,"properties",function(){return this._properties}),n.setRenderer=function(t){this.renderer=t},n.getTileId=function(t,i){var e=this.getTile(t,i);return e?e.gid:0},n.getTile=function(i,e){return this.renderer instanceof t.TMXOrthogonalRenderer?this.layerData[~~this.renderer.pixelToTileX(i)][~~this.renderer.pixelToTileY(e)]:this.renderer instanceof t.TMXIsometricRenderer?this.layerData[~~this.renderer.pixelToTileX(i,e)][~~this.renderer.pixelToTileY(e,i)]:this.layerData[~~this.renderer.pixelToTileX(i,e)][~~this.renderer.pixelToTileY(e,i)]},n.setTile=function(i,e,s){if(this.tileset.contains(s)||(this.tileset=this._tilesets.getTilesetByGid(s)),this.tileset){var r=this.layerData[i][e]=new t.TMXTile(i,e,s,this.tilemap,this.tileset);return r}return null},n.clearTile=function(t,i){this.layerData[t][i]=null},n.draw=function(t){this.renderer.drawTileLayer(this,t)},n.render=function(){this.renderer.render(this._animationContainer)},n.initArray=function(t,i){this.layerData=[];for(var e=0;t>e;e++){this.layerData[e]=[];for(var s=0;i>s;s++)this.layerData[e][s]=null}},n.parseLayerData=function(t){if(t)for(var i=0,e=0;e<this.rows;e++)for(var s=0;s<this.cols;s++){var r=t[i];0!==r&&this.setTile(s,e,r),i++}},e}(t.TMXLayerBase);t.TMXLayer=i,egret.registerClass(i,"tiled.TMXLayer")}(tiled||(tiled={}));var tiled;!function(t){var i=function(i){function e(t,e){i.call(this),this._width=+t.attributes.width,this._height=+t.attributes.height,this._source=t.attributes.source,this._trans="undefined"!=typeof t.attributes.trans?t.attributes.trans:"000000",this._bitmap=new egret.Bitmap,this._source=e+this._source,this.loadImage(this._source)}__extends(e,i);var s=__define,r=e,n=r.prototype;return s(n,"texture",function(){return this._texture}),s(n,"bitmap",function(){return this._bitmap}),s(n,"source",function(){return this._source}),s(n,"width",function(){return this._width}),s(n,"height",function(){return this._height}),n.loadImage=function(i){null!=i&&""!=i&&RES.getResByUrl(i,function(i){i&&(this._bitmap.texture=i,this._texture=i,this._width=i.textureWidth,this._height=i.textureHeight,this.dispatchEvent(new t.TMXImageLoadEvent(t.TMXImageLoadEvent.IMAGE_COMPLETE,i)))},this,RES.ResourceItem.TYPE_IMAGE)},e}(egret.EventDispatcher);t.TMXImage=i,egret.registerClass(i,"tiled.TMXImage")}(tiled||(tiled={}));var tiled;!function(t){var i=function(i){function e(e,s,r,n,h){if(i.call(this),this._points=void 0,this._name=e.attributes.name,this.x=+e.attributes.x,this.y=+e.attributes.y,this._z=+n,this.width=+e.attributes.width||0,this.height=+e.attributes.height||0,this._gid=+e.attributes.gid||null,this._type=e.attributes.type,this.rotation=+e.attributes.rotation||0,this._id=+e.attributes.id||void 0,this._orientation=s,this._shapes=void 0,this._color=h,this._isEllipse=!1,this._isPolygon=!1,this._isPolyLine=!1,this.visible="undefined"!=typeof e.attributes.visible?Boolean(+e.attributes.visible):!0,"number"==typeof this._gid)this._isImage=!0,this.setTile(r);else{this._points=[];var a=e.children;if(a)for(var o=0;o<a.length;o++){var l=a[o];switch(l.localName){case t.TMXConstants.ELLIPSE:this._isEllipse=!0,this._isImage=!1,this._ellipse=this.parseEllipse(l);break;case t.TMXConstants.POLYGON:this._isPolygon=!0,this._isImage=!1,this._points=this.parsePolygonOrPolyline(l.attributes.points);break;case t.TMXConstants.POLYLINE:this._isPolyLine=!0,this._isImage=!1,this._points=this.parsePolygonOrPolyline(l.attributes.points);break;case t.TMXConstants.PROPERTIES:r.tilemap&&(this._properties=r.tilemap.parseProperties(l))}}}this._shapes||(this._shapes=this.parseTMXShapes());for(var o=0;o<this._shapes.length;o++){var d=this._shapes[o];this.addChild(d)}}__extends(e,i);var s=__define,r=e,n=r.prototype;return s(n,"id",function(){return this._id}),s(n,"gid",function(){return this._gid}),s(n,"name",function(){return this._name}),s(n,"type",function(){return this._type}),s(n,"z",function(){return this._z}),s(n,"isEllipse",function(){return this._isEllipse}),s(n,"isPolygon",function(){return this._isPolygon}),s(n,"isPolyLine",function(){return this._isPolyLine}),s(n,"isImage",function(){return this._isImage}),n.parsePolygonOrPolyline=function(t){var i=[],e=t.split(" ");if(e)for(var s=0;s<e.length;s++){var r=e[s].split(",");i[s]=[+r[0],+r[1]]}return i},n.parseEllipse=function(t){var i=+t.attributes.width||32,e=+t.attributes.height||32;return[i,e]},n.parseTMXShapes=function(){var i=[];if(this._isEllipse){var e=new t.Ellipse(0,0,this.width,this.height);e.draw(this._color),i.push(e)}else if(this._isPolygon){var s=new t.Polygon(0,0,this._points);s.draw(this._color),i.push(s)}else if(this._isPolyLine){var r=new t.PolyLine(0,0,this._points);r.draw(this._color),i.push(r)}else if(!this._gid){var s=new t.Polygon(0,0,[[0,0],[this.width,0],[this.width,this.height],[0,this.height]]);s.draw(this._color),i.push(s)}if("isometric"===this._orientation)for(var n=0;n<i.length;n++){var h=i[n];h.rotation=45,h.scaleX=Math.SQRT1_2,h.scaleY=Math.SQRT1_2}return i},n.setTile=function(i){var e=i.getTilesetByGid(this._gid);e&&(this._tile=new t.TMXTile(0,0,this.gid,e.tilemap,e),e.drawTile(this,e.tileoffset.x,e.tileoffset.y-e.tileheight,this._tile))},e}(egret.Sprite);t.TMXObject=i,egret.registerClass(i,"tiled.TMXObject")}(tiled||(tiled={}));var tiled;!function(t){var i=function(i){function e(e,s,r,n){i.call(this),this._name=e.attributes.name,this._opacity="undefined"!=typeof e.attributes.opacity?+e.attributes.opacity:1,this._draworder=e.attributes.draworder,this._color=e.attributes.color?t.TMXUtils.color16ToUnit(e.attributes.color):t.TMXConstants.DEFAULT_COLOR,this._orientaion=s,this._tilesets=r,this._z=n,this.visible="undefined"!=typeof e.attributes.visible?Boolean(+e.attributes.visible):!0,this._objects=[],this._objectHash={},this._childrens=e.children}__extends(e,i);var s=__define,r=e,n=r.prototype;return s(n,"name",function(){return this._name}),n.draw=function(){if(this._childrens)for(var i=0;i<this._childrens.length;i++){var e=new t.TMXObject(this._childrens[i],this._orientaion,this._tilesets,this._z,this._color);e.alpha=this._opacity,this._objects[i]=e,this.addChild(e),this._objectHash[e.id]=e}},n.render=function(){},n.destory=function(){this._objects=null},n.getObjectById=function(t){return this._objectHash[t]},n.removeObjectById=function(t){var i=this.getObjectById(t);i&&i.parent&&i.parent.removeChild(i)},n.showHideObjectById=function(t,i){var e=this.getObjectById(t);e&&(e.visible=!0)},n.getObjectCount=function(){return this._objects.length},n.getObjectByIndex=function(t){return this._objects[t]},n.removeObjectByIndex=function(t){var i=this.getObjectByIndex(t);i&&i.parent&&i.parent.removeChild(i)},e}(egret.Sprite);t.TMXObjectGroup=i,egret.registerClass(i,"tiled.TMXObjectGroup")}(tiled||(tiled={}));var tiled;!function(t){var i=function(){function t(){this.gid=0}var i=(__define,t);i.prototype;return t}();t.TMXProperty=i,egret.registerClass(i,"tiled.TMXProperty")}(tiled||(tiled={}));var tiled;!function(t){var i=function(){function t(t,i,e,s){this.rows=t,this.cols=i,this.tilewidth=e,this.tileheight=s,this.animationTiles=[]}var i=(__define,t),e=i.prototype;return e.canRender=function(t){return this.cols===t.cols&&this.rows===t.rows&&this.tilewidth===t.tilewidth&&this.tileheight===t.tileheight},e.drawTileLayer=function(t,i){},e.drawTile=function(t,i,e,s){},e.render=function(t){if(this.animationTiles)for(var i=egret.getTimer(),e=0;e<this.animationTiles.length;e++){var s=this.animationTiles[e],r=s.tmxTile,n=s.pos,h=r.animation,a=h.currentAnimationFrame;void 0==h.oldTime&&(h.oldTime=0),i-h.oldTime>a.duration&&(h.oldBitmap&&h.oldBitmap.parent&&h.oldBitmap.parent.removeChild(h.oldBitmap),this.drawTile(t,n[0],n[1],a.tile),h.oldBitmap=a.tile.bitmap,h.oldTime=i,h.render())}},t}();t.TMXRenderer=i,egret.registerClass(i,"tiled.TMXRenderer")}(tiled||(tiled={}));var tiled;!function(t){var i=function(i){function e(t,e,s,r,n,h,a){i.call(this,t,e,s,r),this._hexsidelength=n,this._staggeraxis=h,this._staggerindex=a,this._sidelengthx=0,this._sidelengthy=0,"x"===h?this._sidelengthx=n:this._sidelengthy=n,this._sideoffsetx=(this.tilewidth-this._sidelengthx)/2,this._sideoffsety=(this.tileheight-this._sidelengthy)/2,this._columnwidth=this._sideoffsetx+this._sidelengthx,this._rowheight=this._sideoffsety+this._sidelengthy,this._centers=[new egret.Point,new egret.Point,new egret.Point,new egret.Point]}__extends(e,i);var s=(__define,e),r=s.prototype;return r.canRender=function(e){return e.orientation===t.TMXConstants.ORIENTATION_HEXAGONAL&&i.prototype.canRender.call(this,e)},r.pixelToTileCoords=function(t,i){"x"===this._staggeraxis?t-="old"===this._staggerindex?this._sidelengthx:this.tilewidth:i-="old"===this._staggerindex?this._sideoffsety:this.tileheight;var e=new egret.Point(Math.floor(t/(this.tilewidth+this._sidelengthx)),Math.floor(i/(this.tileheight+this._sidelengthy))),s=new egret.Point(t-e.x*(this.tilewidth+this._sidelengthx),i-e.y*(this.tilewidth+this._sidelengthy));"x"===this._staggeraxis?(e.x=2*e.x,"even"===this._staggerindex&&++e.x):(e.y=2*e.y,"even"===this._staggerindex&&++e.y);var r,n,h,a;"x"===this._staggeraxis?(r=this._sidelengthx/2,h=r+this._columnwidth,a=this.tileheight/2,this._centers[0].setTo(r,a),this._centers[1].setTo(h,a-this._rowheight),this._centers[2].setTo(h,a+this._rowheight),this._centers[3].setTo(h+this._columnwidth,a)):(n=this._sidelengthy/2,h=this.tilewidth/2,a=n+this._rowheight,this._centers[0].setTo(h,n),this._centers[1].setTo(h-this._columnwidth,a),this._centers[2].setTo(h+this._columnwidth,a),this._centers[3].setTo(h,a+this._rowheight));for(var o,l=0,d=Number.MAX_VALUE,_=0;4>_;++_)o=Math.pow(this._centers[_].x-s.x,2)+Math.pow(this._centers[_].y-s.y,2),d>o&&(d=o,l=_);var u=[{x:0,y:0},{x:1,y:-1},{x:1,y:0},{x:2,y:0}],c=[{x:0,y:0},{x:-1,y:1},{x:0,y:1},{x:0,y:2}],g="x"===this._staggeraxis?u:c;return new egret.Point(e.x+g[l].x,e.y+g[l].y)},r.pixelToTileX=function(t,i){var e=this.pixelToTileCoords(t,i);return e.x},r.pixelToTileY=function(t,i){var e=this.pixelToTileCoords(i,t);return e.y},r.tileToPixelCoords=function(t,i){var e,s;return"x"===this._staggeraxis?(e=t*this._columnwidth,"odd"===this._staggerindex?(s=i*(this.tileheight+this._sidelengthy),s+=this._rowheight*(1&t)):(s=i*(this.tileheight+this._sidelengthy),s+=this._rowheight*(1-(1&t)))):(s=i*this._rowheight,"odd"===this._staggerindex?(e=t*(this.tilewidth+this._sidelengthx),e+=this._columnwidth*(1&i)):(e=t*(this.tilewidth+this._sidelengthx),e+=this._columnwidth*(1-(1&i)))),new egret.Point(e,s)},r.drawTile=function(t,i,e,s){var r=this.tileToPixelCoords(i,e),n=s.tileset;n.drawTile(t,n.tileoffset.x+r.x,n.tileoffset.y+r.y+(this.tileheight-n.tileheight),s)},r.drawTileLayer=function(t,i){var e=t.staticContainer,s=this.pixelToTileCoords(Math.floor(i.x),Math.floor(i.y)),r=this.pixelToTileCoords(Math.floor(i.x+i.width+this.tilewidth),Math.floor(i.y+i.height+this.tileheight));s.x=s.x<0?0:s.x,s.y=s.y<0?0:s.y,r.x=r.x>this.rows?this.rows:r.x,r.y=r.y>this.cols?this.cols:r.y;for(var n=s.y;n<r.y;n++)for(var h=s.x;h<r.x;h++){var a=t.layerData[h][n];a&&(a.animation?this.animationTiles.push({tmxTile:a,pos:[h,n]}):this.drawTile(e,h,n,a))}},e}(t.TMXRenderer);t.TMXHexagonalRenderer=i,egret.registerClass(i,"tiled.TMXHexagonalRenderer")}(tiled||(tiled={}));var tiled;!function(t){var i=function(i){function e(t,e,s,r){i.call(this,t,e,s,r),this._hTilewidth=this.tilewidth/2,this._hTileheight=this.tileheight/2,this._originX=this.rows*this._hTilewidth}__extends(e,i);var s=(__define,e),r=s.prototype;return r.canRender=function(e){return e.orientation===t.TMXConstants.ORIENTATION_ISOMETRIC&&i.prototype.canRender.call(this,e)},r.pixelToTileCoords=function(t,i){Math.floor(this.pixelToTileX(t,i)),Math.floor(this.pixelToTileY(i,t));return new egret.Point(this.pixelToTileX(t,i),this.pixelToTileY(i,t))},r.pixelToTileX=function(t,i){i/this.tileheight+(t-this._originX)/this.tilewidth;return i/this.tileheight+(t-this._originX)/this.tilewidth},r.pixelToTileY=function(t,i){t/this.tileheight-(i-this._originX)/this.tilewidth;return t/this.tileheight-(i-this._originX)/this.tilewidth},r.tileToPixelCoords=function(t,i){return new egret.Point((t-i)*this._hTilewidth+this._originX,(t+i)*this._hTileheight)},r.drawTile=function(t,i,e,s){var r=s.tileset;r.drawTile(t,r.tileoffset.x+i,r.tileoffset.y+e-r.tileheight,s)},r.drawTileLayer=function(t,i){var e=t.staticContainer,s=t.tileset,r=s.tileoffset,n=this.pixelToTileCoords(i.x-s.tilewidth,i.y-s.tileheight);n=new egret.Point(Math.floor(n.x),Math.floor(n.y));var h=this.pixelToTileCoords(i.x+i.width+s.tilewidth,i.y+i.height+s.tileheight);h=new egret.Point(Math.ceil(h.x),Math.ceil(h.y));var a=this.tileToPixelCoords(h.x,h.y),o=this.tileToPixelCoords(n.x,n.y);o.x-=this._hTilewidth,o.y+=this.tileheight;var l=o.y-i.y>this._hTileheight,d=i.x-o.x<this._hTilewidth;l&&(d?(n.x--,o.x-=this._hTilewidth):(n.y--,o.x+=this._hTilewidth),o.y-=this._hTileheight);for(var _=Boolean(+l^+d),u=n.clone(),c=o.y;c-this.tileheight<a.y;c+=this._hTileheight){u.setTo(n.x,n.y);for(var g=o.x;g<a.x;g+=this.tilewidth){if(u.x>=0&&u.y>=0&&u.x<this.rows&&u.y<this.cols){var f=t.layerData[u.x][u.y];f&&(s=f.tileset,r=s.tileoffset,f&&(f.animation?this.animationTiles.push({tmxTile:f,pos:[r.x+g,r.y+c]}):this.drawTile(e,g,c,f)))}u.x++,u.y--}_?(n.y++,o.x-=this._hTilewidth,_=!1):(n.x++,o.x+=this._hTilewidth,_=!0)}},e}(t.TMXRenderer);t.TMXIsometricRenderer=i,egret.registerClass(i,"tiled.TMXIsometricRenderer")}(tiled||(tiled={}));var tiled;!function(t){var i=function(i){function e(t,e,s,r){i.call(this,t,e,s,r)}__extends(e,i);var s=(__define,e),r=s.prototype;return r.canRender=function(e){return e.orientation===t.TMXConstants.ORIENTATION_ORTHOGONAL&&i.prototype.canRender.call(this,e)},r.pixelToTileCoords=function(t,i){return new egret.Point(this.pixelToTileX(t),this.pixelToTileY(i))},r.pixelToTileX=function(t){return Math.floor(t/this.tilewidth)},r.pixelToTileY=function(t){return Math.floor(t/this.tileheight)},r.tileToPixelCoords=function(t,i){return new egret.Point(t*this.tilewidth,i*this.tileheight)},r.drawTile=function(t,i,e,s){var r=s.tileset;r.drawTile(t,r.tileoffset.x+i*this.tilewidth,r.tileoffset.y+(e+1)*this.tileheight-r.tileheight,s)},r.drawTileLayer=function(t,i){var e=t.staticContainer,s=this.pixelToTileCoords(Math.floor(Math.max(i.x-(t.maxTileSize.width-t.tilewidth),0)),Math.floor(Math.max(i.y-(t.maxTileSize.height-t.tileheight),0))),r=this.pixelToTileCoords(Math.ceil(i.x+i.width+this.tilewidth),Math.ceil(i.y+i.height+this.tileheight));r.x=r.x>this.rows?this.rows:r.x,r.y=r.y>this.cols?this.cols:r.y;for(var n=s.y;n<r.y;n++)for(var h=s.x;h<r.x;h++){var a=t.layerData[h][n];a&&(a.animation?this.animationTiles.push({tmxTile:a,pos:[h,n]}):this.drawTile(e,h,n,a))}},e}(t.TMXRenderer);t.TMXOrthogonalRenderer=i,egret.registerClass(i,"tiled.TMXOrthogonalRenderer")}(tiled||(tiled={}));var tiled;!function(t){var i=function(t){function i(i,e,s,r){t.call(this),this.x=i,this.y=e,this.width=s,this.height=r}__extends(i,t);var e=(__define,i),s=e.prototype;return s.draw=function(t){this.graphics.clear(),this.graphics.lineStyle(2,t),this.graphics.beginFill(t,.2),this.graphics.drawEllipse(0,0,this.width,this.height),this.graphics.endFill()},i}(egret.Sprite);t.Ellipse=i,egret.registerClass(i,"tiled.Ellipse")}(tiled||(tiled={}));var tiled;!function(t){var i=function(t){function i(i,e,s){t.call(this),this.points=s,this.x=i,this.y=e}__extends(i,t);var e=(__define,i),s=e.prototype;return s.draw=function(t){if(this.graphics.clear(),this.graphics.lineStyle(2,t),this.graphics.beginFill(t,.2),this.points)for(var i=0;i<this.points.length;i++){var e=this.points[i];0==i?this.graphics.moveTo(e[0],e[1]):this.graphics.lineTo(e[0],e[1])}this.graphics.endFill()},i}(egret.Sprite);t.Polygon=i,egret.registerClass(i,"tiled.Polygon")}(tiled||(tiled={}));var tiled;!function(t){var i=function(t){function i(i,e,s){t.call(this),this.points=s,this.x=i,this.y=e}__extends(i,t);var e=(__define,i),s=e.prototype;return s.draw=function(t){if(this.graphics.clear(),this.graphics.lineStyle(2,t),this.graphics.beginFill(t,.2),this.points)for(var i=0;i<this.points.length;i++){var e=this.points[i];0==i?this.graphics.moveTo(e[0],e[1]):this.graphics.lineTo(e[0],e[1])}this.graphics.endFill()},i}(egret.Sprite);t.PolyLine=i,egret.registerClass(i,"tiled.PolyLine")}(tiled||(tiled={}));var tiled;!function(t){var i=function(i){function e(e,s,r,n,h){if(i.call(this),this._tileset=h,this._tileX=e,this._tileY=s,this._tilemap=n,this._gid=r,this._flippedX=0!==(this._gid&t.TMXConstants.TMX_FLIP_H),this._flippedY=0!==(this._gid&t.TMXConstants.TMX_FLIP_V),this._flippedAD=this._flippedX&&this._flippedY,this._flipped=this._flippedX||this._flippedY||this._flippedAD,this._gid&=t.TMXConstants.TMX_CLEAR_BIT_MASK,this._tileData=h.getSpecialTileDataByTileId(this._gid),this._tileData){var a=this._tileData.children;if(a)for(var o=0;o<a.length;o++){var l=a[o];switch(l.localName){case t.TMXConstants.PROPERTIES:this._properties=n.parseProperties(l);break;case t.TMXConstants.OBJECT_GROUP:break;case t.TMXConstants.IMAGE:this._image=new t.TMXImage(l,this.tilemap.baseURL);break;case t.TMXConstants.ANIMATION:this._animation=new t.TMXAnimation(n,h,e,s,l)}}}}__extends(e,i);var s=__define,r=e,n=r.prototype;return s(n,"gid",function(){return this._gid}),s(n,"tileX",function(){return this._tileX}),s(n,"tileY",function(){return this._tileY}),s(n,"tileset",function(){return this._tileset}),s(n,"image",function(){return this._image}),s(n,"tilemap",function(){return this._tilemap}),s(n,"flippedX",function(){return this._flippedX}),s(n,"flippedY",function(){return this._flippedY}),s(n,"flippedAD",function(){return this._flippedAD}),s(n,"flipped",function(){return this._flipped}),s(n,"animation",function(){return this._animation}),e}(egret.Sprite);t.TMXTile=i,egret.registerClass(i,"tiled.TMXTile")}(tiled||(tiled={}));var tiled;!function(t){var i=function(){function i(i,e){this.getFileExtension=function(t){return t.substring(t.lastIndexOf(".")+1,t.length)},this._tileDatas=[],this._firstgid=+e.attributes.firstgid,this._lastgid=this._firstgid,this._tilemap=i;var s=e.attributes.source;if(s&&"tsx"===this.getFileExtension(s))throw new Error("tmx not support tsx file load!!!");this._transformMatrix=new egret.Matrix,this._name=e.attributes.name,this._tilewidth=+e.attributes.tilewidth,this._tileheight=+e.attributes.tileheight,this._spacing=+e.attributes.spacing||0,this._margin=+e.attributes.margin||0,this._tileoffset=new egret.Point,this._hTileCount=0,this._vTileCount=0,this._images=[];var r=e.children;if(r)for(var n=0;n<r.length;n++){var h=r[n];switch(h.localName){case t.TMXConstants.IMAGE:this._image=new t.TMXImage(h,this.tilemap.baseURL),this._imagesource=this._image.source,this._images.push(this._image);break;case t.TMXConstants.TILE_OFFSET:this._tileoffset=new egret.Point(+h.attributes.x,+h.attributes.y);break;case t.TMXConstants.TILE:var a=+h.attributes.id+this._firstgid;null==this._tileDatas[a]&&(this._tileDatas[a]=h),h.children&&h.children.length>0&&h.children[0].localName==t.TMXConstants.IMAGE&&(this._image=new t.TMXImage(h.children[0],this.tilemap.baseURL),this._imagesource=this._image.source,this._images.push(this._image));break;case t.TMXConstants.PROPERTIES:this._properties=i.parseProperties(h)}}this._image&&(this._hTileCount=~~(this._image.width/(this._tilewidth+this._spacing)),this._vTileCount=~~(this._image.height/(this._tileheight+this._margin)),this._lastgid=this._firstgid+(this._hTileCount*this._vTileCount-1||0))}var e=__define,s=i,r=s.prototype;return e(r,"name",function(){return this._name}),e(r,"firstgid",function(){return this._firstgid}),e(r,"lastgid",function(){return this._lastgid}),e(r,"tilewidth",function(){return this._tilewidth}),e(r,"tileheight",function(){return this._tileheight}),e(r,"spacing",function(){return this._spacing}),e(r,"margin",function(){return this._margin}),e(r,"tileoffset",function(){return this._tileoffset}),e(r,"horizontalTileCount",function(){return this._hTileCount}),e(r,"verticalTileCount",function(){return this._vTileCount}),e(r,"tilemap",function(){return this._tilemap}),e(r,"properties",function(){return this._properties}),e(r,"image",function(){return this._image}),e(r,"images",function(){return this._images}),r.getSpecialTileDataByTileId=function(t){return this._tileDatas[t]},r.getProperties=function(){return this._properties},r.getPropertyByIndex=function(t){return this._properties&&t<this._properties.length?this._properties[t]:null},r.contains=function(t){return t>=this._firstgid&&t<=this._lastgid},r.drawTile=function(i,e,s,r){var n,h,a;if(a=[],this.images)for(var o=0;o<this.images.length;o++){var l=this.images[o];l&&(null==t.TMXTileset.spritesheets[l.source]?(h=new egret.SpriteSheet(l.texture),t.TMXTileset.spritesheets[l.source]=h):h=t.TMXTileset.spritesheets[l.source])}for(var o=0;o<this.images.length;o++){var d=this.images[o];d&&a.push(t.TMXTileset.spritesheets[d.source])}var _,u=r.gid-this.firstgid,c=this.firstgid+"_"+u;if(this.images.length>1){_=a[r.gid-this.firstgid];var g=new egret.Rectangle(0*(this.tilewidth+this._spacing)+this._spacing,0*(this.tileheight+this._margin)+this._margin,this.tilewidth,this.tileheight)}else{_=a[0];var g=new egret.Rectangle(u%this.horizontalTileCount*(this.tilewidth+this._spacing)+this._spacing,Math.floor(u/this.horizontalTileCount)*(this.tileheight+this._margin)+this._margin,this.tilewidth,this.tileheight)}n=_.createTexture(c,g.x,g.y,g.width,g.height,0,0);var f=!1,p=!1;i instanceof t.TMXObject&&(p=!0,f=i.isImage),this._transformMatrix.identity();var T=p?i.width/n.textureWidth:1,m=p?i.height/n.textureHeight:1;r.flippedAD?(this._transformMatrix.scale(-1*T,-1*m),this._transformMatrix.translate(e+i.width*T,s+i.height*m)):r.flippedY?(this._transformMatrix.scale(1*T,-1*m),this._transformMatrix.translate(e,s+i.height*m)):r.flippedX?(this._transformMatrix.scale(-1*T,1*m),this._transformMatrix.translate(e+i.width*T,s)):(this._transformMatrix.scale(T,m),this._transformMatrix.translate(e,s+(p?n.textureHeight-i.height:0))),null==r.bitmap&&(r.bitmap=new egret.Bitmap),r.bitmap.texture=n,r.bitmap.matrix=this._transformMatrix,i.addChild(r.bitmap),r.bitmap=r.bitmap},i.removeAllTextures=function(){for(var t in this.spritesheets)var i=this.spritesheets[t];this.spritesheets={}},i.spritesheets={},i}();t.TMXTileset=i,egret.registerClass(i,"tiled.TMXTileset")}(tiled||(tiled={}));var tiled;!function(t){var i=function(){function i(t){this._tilesets=[],this._length=0,this._imagelength=0,this._tilemap=t}var e=__define,s=i,r=s.prototype;return e(r,"length",function(){return this._length}),e(r,"imagelength",function(){return this._imagelength}),e(r,"tilemap",function(){return this._tilemap}),r.add=function(t){this._tilesets.push(t),this._length++,t.images&&(this._imagelength+=t.images.length)},r.getTilesetByIndex=function(t){return this._tilesets[t]},r.getTilesetByGid=function(i){if(0===i)return null;var e=-1;i&=t.TMXConstants.TMX_CLEAR_BIT_MASK;for(var s=0,r=this._tilesets.length;r>s;s++){var n=this._tilesets[s];if(n.contains(i))return n;n.firstgid===n.lastgid&&i>=n.firstgid&&(e=s)}if(-1!==e)return this._tilesets[e];throw new Error("no matching tileset found for gid "+i)},i}();t.TMXTilesetGroup=i,egret.registerClass(i,"tiled.TMXTilesetGroup")}(tiled||(tiled={}));var tiled;!function(t){var i=function(i){function e(e,s,r,n){i.call(this),this._tmxRenderer=null,this._data=r,this._renderWidth=e,this._renderHeight=s,this._rows=+r.attributes.width,this._cols=+r.attributes.height,this._tilewidth=+r.attributes.tilewidth,this._tileheight=+r.attributes.tileheight,this._nextobjectid=+r.attributes.nextobjectid,this._version=+r.attributes.version,this._orientation=r.attributes.orientation,this._renderorder=r.attributes.renderorder,this._baseURL=n,this._baseURL=decodeURIComponent(this._baseURL);var h=this._baseURL.lastIndexOf("/");this._baseURL=this._baseURL.slice(0,h+1),this._orientation===t.TMXConstants.ORIENTATION_ISOMETRIC?(this.width=(this._rows+this._cols)*(this._tilewidth/2),this.height=(this._rows+this._cols)*(this._tileheight/2)):(this.width=this._rows*this._tilewidth,this.height=this._cols*this._tileheight),this._hexsidelength=+r.attributes.hexsidelength,this._staggeraxis=r.attributes.staggeraxis||void 0,this._staggerindex=r.attributes.staggerindex||void 0,this._backgroundcolor=r.attributes.backgroundcolor,this._z=0,this._layers=[],null!==this._tmxRenderer&&this._tmxRenderer.canRender(this)||(this._tmxRenderer=this.getNewDefaultRenderer(this)),this._initialized=!1}__extends(e,i);var s=__define,r=e,n=r.prototype;return s(n,"nextobjectid",function(){return this._nextobjectid}),s(n,"tilewidth",function(){return this._tilewidth
}),s(n,"tileheight",function(){return this._tileheight}),s(n,"rows",function(){return this._rows}),s(n,"cols",function(){return this._cols}),s(n,"baseURL",function(){return this._baseURL}),s(n,"renderwidth",function(){return this._renderWidth}),s(n,"renderheight",function(){return this._renderHeight}),n.render=function(){for(var t=this.getLayers(),i=0;i<t.length;i++)this.addChild(t[i]);this.addEventListener(egret.Event.ENTER_FRAME,this.onStartRendering,this)},n.getLayers=function(){return this.readMapObjects(this._data),this._layers},n.getObjects=function(){this.readMapObjects(this._data);for(var i=[],e=0;e<this._layers.length;e++)this._layers[e]instanceof t.TMXObjectGroup&&i.push(this._layers[e]);return i},n.parseProperties=function(i){var e,s=i.children;if(s){e=[];for(var r=0;r<s.length;r++){var n=s[r],h=new t.TMXProperty;h.name=n.attributes.name,h.value=n.attributes.value,e[r]=h}}return e},n.showHideBackground=function(i){this._showHideBackground=i;for(var e=0;e<this._layers.length;e++){var s=this._layers[e];if(s instanceof t.TMXColorLayer)return void(s.visible=i)}},n.destory=function(){this._tilesets=void 0,this._layers=[],this._initialized=!1,this.removeEventListener(egret.Event.ENTER_FRAME,this.onStartRendering,this),t.TMXTileset.removeAllTextures(),this.parent&&this.parent.removeChild(this)},n.readMapObjects=function(i){if(this._initialized!==!0){var e=this._z,s=this;this._tilesets||(this._tilesets=new t.TMXTilesetGroup(this)),this._backgroundcolor&&this._showHideBackground&&this._layers.push(new t.TMXColorLayer(this,this._backgroundcolor,e++));var r=this._data.children;if(r)for(var n=0;n<r.length;n++){var h=r[n];switch(h.localName){case t.TMXConstants.TILE_SET:this._tilesets.add(new t.TMXTileset(this,h));break;case t.TMXConstants.LAYER:this._layers.push(this.parseLayer(h,e++));break;case t.TMXConstants.OBJECT_GROUP:this._layers.push(this.parseObjectGroup(h,e++));break;case t.TMXConstants.PROPERTIES:this._properties=this.parseProperties(h);break;case t.TMXConstants.IMAGE_LAYER:this._layers.push(this.parseImageLayer(h,e++))}}for(var a=0,n=0;n<this._tilesets.length;n++)for(var o=this._tilesets.getTilesetByIndex(n),l=0;l<o.images.length;l++){var d=o.images[l],_=function(i){var e=i.currentTarget;e.removeEventListener(t.TMXImageLoadEvent.IMAGE_COMPLETE,_,this),a++,a==this._tilesets.imagelength&&s.dispatchEvent(new t.TMXImageLoadEvent(t.TMXImageLoadEvent.ALL_IMAGE_COMPLETE))};d.addEventListener(t.TMXImageLoadEvent.IMAGE_COMPLETE,_,this)}this._initialized=!0}},n.onStartRendering=function(i){for(var e=this.getLayers(),s=0;s<e.length;s++){var r=e[s];r instanceof t.TMXLayer&&r.render()}for(var n=this.getObjects(),s=0;s<n.length;s++){n[s]}},n.getNewDefaultRenderer=function(i){switch(i._orientation){case"orthogonal":return new t.TMXOrthogonalRenderer(i.rows,i.cols,i.tilewidth,i.tileheight);case"isometric":return new t.TMXIsometricRenderer(i.rows,i.cols,i.tilewidth,i.tileheight);case"hexagonal":return new t.TMXHexagonalRenderer(i.rows,i.cols,i.tilewidth,i.tileheight,i._hexsidelength,i._staggeraxis,i._staggerindex);default:throw new Error(i._orientation+" type TMX Tile Map not supported!")}},n.parseLayer=function(i,e){var s=new t.TMXLayer(this,this._tilewidth,this._tileheight,this._orientation,this._tilesets,e,i);this._tmxRenderer.canRender(s)?s.setRenderer(this.getNewDefaultRenderer(this)):s.setRenderer(this._tmxRenderer);var r=this,n=function(i){r.removeEventListener(t.TMXImageLoadEvent.ALL_IMAGE_COMPLETE,n,this),this.draw(new egret.Rectangle(0,0,r._renderWidth,r._renderHeight))};return this.addEventListener(t.TMXImageLoadEvent.ALL_IMAGE_COMPLETE,n,s),s},n.parseObjectGroup=function(i,e){var s=new t.TMXObjectGroup(i,this._orientation,this._tilesets,e),r=this,n=function(i){r.removeEventListener(t.TMXImageLoadEvent.ALL_IMAGE_COMPLETE,n,this),this.draw(new egret.Rectangle(0,0,r._renderWidth,r._renderHeight))};return this.addEventListener(t.TMXImageLoadEvent.ALL_IMAGE_COMPLETE,n,s),s},n.parseTileset=function(i){return new t.TMXTileset(i,this)},n.parseImageLayer=function(i,e){var s=this,r=new t.TMXImageLayer(this,i,e),n=function(t){this.draw(new egret.Rectangle(0,0,s._renderWidth,s._renderHeight))};return r.addEventListener(t.TMXImageLoadEvent.IMAGE_COMPLETE,n,r),r},e}(egret.Sprite);t.TMXTilemap=i,egret.registerClass(i,"tiled.TMXTilemap")}(tiled||(tiled={}));var tiled;!function(t){var i=function(){function t(){}var i=__define,e=t;e.prototype;return i(t,"nativeBase64",function(){return"function"==typeof window.atob}),t.decode=function(t){if(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,""),this.nativeBase64)return window.atob(t);for(var i,e,s,r,n,h,a,o=[],l=0;l<t.length;)r=this._keyStr.indexOf(t.charAt(l++)),n=this._keyStr.indexOf(t.charAt(l++)),h=this._keyStr.indexOf(t.charAt(l++)),a=this._keyStr.indexOf(t.charAt(l++)),i=r<<2|n>>4,e=(15&n)<<4|h>>2,s=(3&h)<<6|a,o.push(String.fromCharCode(i)),64!==h&&o.push(String.fromCharCode(e)),64!==a&&o.push(String.fromCharCode(s));return o=o.join("")},t.encode=function(t){if(t=t.replace(/\r\n/g,"\n"),!this.nativeBase64){for(var i,e,s,r,n,h,a,o=[],l=0;l<t.length;)i=t.charCodeAt(l++),e=t.charCodeAt(l++),s=t.charCodeAt(l++),r=i>>2,n=(3&i)<<4|e>>4,h=(15&e)<<2|s>>6,a=63&s,isNaN(e)?h=a=64:isNaN(s)&&(a=64),o.push(this._keyStr.charAt(r)),o.push(this._keyStr.charAt(n)),o.push(this._keyStr.charAt(h)),o.push(this._keyStr.charAt(a));return o=o.join("")}window.btoa(t)},t.decodeBase64AsArray=function(i,e){e=e||1;var s,r,n,h=t.decode(i),a=new Uint32Array(h.length/e);for(s=0,n=h.length/e;n>s;s++)for(a[s]=0,r=e-1;r>=0;--r)a[s]+=h.charCodeAt(s*e+r)<<(r<<3);return a},t.decompress=function(t,i,e){throw new Error("GZIP/ZLIB compressed TMX Tile Map not supported!")},t.decodeCSV=function(t){for(var i=t.replace("\n","").trim().split(","),e=[],s=0;s<i.length;s++)e.push(+i[s]);return e},t._keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t}();t.Base64=i,egret.registerClass(i,"tiled.Base64")}(tiled||(tiled={}));var tiled;!function(t){var i=function(){function i(){}var e=(__define,i);e.prototype;return i.create=function(i,e,s,r,n,h){void 0===n&&(n=null),void 0===h&&(h=null),RES.getResByUrl(s,function(a){try{var a=egret.XML.parse(a)}catch(o){throw new Error("tmx文件格式不正确！")}var l=new t.TMXTilemap(i,e,a,s);l.render(),r.addChild(l),n&&n.apply(h)},this,RES.ResourceItem.TYPE_XML)},i.decode=function(i,e,s){s=s||"none",e=e||"none";var r=i.children[0].text;switch(e){case"base64":var n=t.Base64.decodeBase64AsArray(r,4);return"none"===s?n:t.Base64.decompress(r,n,s);case"csv":return t.Base64.decodeCSV(r);case"none":for(var h=[],a=0;a<i.children.length;a++)h[a]=+i.children[a].attributes.gid;return h;default:throw new Error("未定义的编码:"+e)}},i.color16ToUnit=function(t){var i="0x"+t.slice(1);return parseInt(i,16)},i}();t.TMXUtils=i,egret.registerClass(i,"tiled.TMXUtils")}(tiled||(tiled={}));